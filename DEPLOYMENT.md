# Vercel Deployment Guide

This guide covers deploying the Tweet Garot PM full-stack application to Vercel as a **monorepo**.

## Prerequisites

- Vercel account (already connected to this project)
- PostgreSQL database (Vercel Postgres, Neon, or Supabase recommended)
- Git repository connected to Vercel

## ⚠️ Important: Monorepo Architecture

This project uses a **monorepo structure** with separate `frontend/` and `backend/` directories.

**You MUST create TWO separate Vercel projects:**
1. One for the frontend (pointing to `/frontend` directory)
2. One for the backend (pointing to `/backend` directory)

This is required because Vercel treats each directory as an independent deployable unit.

## Database Setup

### Option 1: Vercel Postgres (Recommended)

1. Go to your Vercel project dashboard
2. Navigate to **Storage** → **Create Database** → **Postgres**
3. Note the connection string provided

### Option 2: External PostgreSQL (Neon, Supabase, etc.)

1. Create a PostgreSQL database on your preferred platform
2. Get the connection string (format: `postgresql://user:password@host:port/database`)

## Environment Variables

Configure these in your Vercel project settings (**Settings** → **Environment Variables**):

### Backend Variables

```
DATABASE_URL=postgresql://user:password@host:port/database
JWT_SECRET=your-secure-random-string-here
NODE_ENV=production
PORT=3001
```

### Frontend Variables (if needed)

```
REACT_APP_API_URL=/api
```

**Note:** Since the frontend and backend are deployed together, the API calls use relative paths (`/api`).

## Database Migration

After setting up your database, you need to run migrations:

### Option 1: Local Migration (Recommended)

1. Update your local `backend/.env` with the production database URL
2. Run migrations locally:
   ```bash
   cd backend
   npm run migrate
   npm run seed  # Optional: add test data
   ```

### Option 2: Using Vercel CLI

1. Install Vercel CLI: `npm i -g vercel`
2. Link your project: `vercel link`
3. Pull environment variables: `vercel env pull`
4. Run migration script with production variables

## Deployment Steps

### Step 1: Create Backend Project

1. Go to [Vercel Dashboard](https://vercel.com/dashboard)
2. Click **"Add New..."** → **"Project"**
3. Import your Git repository
4. **CRITICAL:** Set **Root Directory** to `backend`
5. Keep Framework Preset as "Other"
6. Add environment variables (see below)
7. Click **Deploy**
8. **Save the backend URL** (e.g., `https://your-backend.vercel.app`)

### Step 2: Create Frontend Project

1. Go back to Vercel Dashboard
2. Click **"Add New..."** → **"Project"**
3. Import the **same Git repository** again
4. **CRITICAL:** Set **Root Directory** to `frontend`
5. Framework Preset should auto-detect "Create React App"
6. Update `frontend/vercel.json` with your actual backend URL:
   ```json
   {
     "rewrites": [
       {
         "source": "/api/:path*",
         "destination": "https://YOUR-BACKEND-URL.vercel.app/api/:path*"
       }
     ]
   }
   ```
7. Click **Deploy**

### Step 3: Link Projects (Optional but Recommended)

For automatic preview URLs, use Related Projects:

1. In frontend project → **Settings** → **Git**
2. Add backend project as a related project
3. This ensures preview deployments automatically use the correct backend preview URL

## Project Structure for Vercel

```
TweetGarotPM/
├── vercel.json           # Root config (minimal, for GitHub settings)
├── .vercelignore         # Files to exclude from deployment
├── frontend/
│   ├── vercel.json       # Frontend-specific config (API rewrites)
│   ├── package.json      # Must have "vercel-build" script
│   └── build/            # Generated by React build (auto-detected)
└── backend/
    ├── vercel.json       # Backend-specific config (serverless routes)
    └── src/
        └── index.js      # Exported Express app (serverless-compatible)
```

## How It Works

- **Two Separate Deployments:**
  - Frontend project deploys from `/frontend` directory
  - Backend project deploys from `/backend` directory
- **Frontend:** Built as static files (Create React App)
- **Backend:** Runs as serverless functions
- **API Communication:** Frontend rewrites `/api/*` requests to backend URL
- **Database:** PostgreSQL connection via environment variables

## Troubleshooting

### Build Failures

1. Check Vercel build logs for errors
2. Ensure all dependencies are in `package.json` (not just `devDependencies`)
3. Verify Node.js version compatibility

### Database Connection Issues

1. Verify `DATABASE_URL` is set correctly in Vercel environment variables
2. Check database allows connections from Vercel IPs
3. Ensure SSL/TLS is configured properly (add `?sslmode=require` to connection string if needed)

### API Routes Not Working

1. Check that all API calls in frontend use `/api` prefix
2. Verify `vercel.json` routes are configured correctly
3. Check backend logs in Vercel Functions dashboard

### File Upload Issues

Vercel serverless functions have a 4.5MB request body limit. For larger files:
- Consider using Vercel Blob storage
- Or use a third-party service (AWS S3, Cloudinary, etc.)

## Environment-Specific Considerations

### CORS

CORS is already configured in the backend. For production, you may want to restrict origins:

```javascript
// backend/src/index.js
app.use(cors({
  origin: process.env.FRONTEND_URL || '*'
}));
```

### Database Connection Pooling

For serverless environments, consider using connection pooling:

```bash
DATABASE_URL=postgresql://user:password@host:port/database?pgbouncer=true
```

## Monitoring

- **Build logs:** Vercel Dashboard → Deployments
- **Function logs:** Vercel Dashboard → Functions
- **Analytics:** Vercel Dashboard → Analytics

## Custom Domain (Optional)

1. Go to Vercel project → **Settings** → **Domains**
2. Add your custom domain
3. Update DNS records as instructed
4. Vercel automatically provisions SSL certificate

## Continuous Deployment

Vercel automatically deploys:
- **Production:** Pushes to `main` branch → Production URL
- **Preview:** Pull requests → Unique preview URL

## Next Steps

1. ✅ Configure environment variables in Vercel
2. ✅ Set up PostgreSQL database
3. ✅ Run database migrations
4. ✅ Push code to trigger deployment
5. ✅ Test the deployed application
6. Configure custom domain (optional)
